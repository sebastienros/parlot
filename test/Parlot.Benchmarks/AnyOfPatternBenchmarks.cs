using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using Parlot.Fluent;
using System;
using static Parlot.Fluent.Parsers;

namespace Parlot.Benchmarks;

[MemoryDiagnoser, GroupBenchmarksBy(BenchmarkLogicalGroupRule.ByCategory), ShortRunJob]
public class AnyOfPatternBenchmarks
{
    private const string DigitsSet = "0123456789";

    // Explicit, non-contiguous set of non-digit chars used to build the non-digit inputs.
    // (No ranges; the input is generated by repeating this set.)
    private const string NonDigitsSet = "aekqzBHNPRTVXZ!$%&*+-/:;=?@[]_{}~";

    private const string DigitsSmall = "28";
    private const string DigitsMedium = "975312468097";
    private const string DigitsLarge = "975312468097975312468097975312468097";

    private const string NonDigitsSmall = "BH";
    private const string NonDigitsMedium = "aekqzBHNPRTV";
    private const string NonDigitsLarge = "aekqzB?NPRT~XZaekqzBHNPRTVXZa?kqzBH~PRTVXZ";

    // 0=small, 1=medium, 2=large (large matches the previous sample)
    [Params(0, 1, 2)]
    public int Size { get; set; }

    private string DigitsInput => Size switch
    {
        0 => DigitsSmall,
        1 => DigitsMedium,
        _ => DigitsLarge,
    };

    private string LettersInput => Size switch
    {
        0 => NonDigitsSmall,
        1 => NonDigitsMedium,
        _ => NonDigitsLarge,
    };

    private static readonly Parser<TextSpan> AnyOfDigits = Literals.AnyOf(DigitsSet);
    private static readonly Parser<TextSpan> PatternIsDigit = Literals.Pattern(char.IsDigit);
    private static readonly Parser<TextSpan> PatternDigitsContains = Literals.Pattern(static c => DigitsSet.Contains(c));

    private static readonly Parser<TextSpan> AnyOfNonDigitsSet = Literals.AnyOf(NonDigitsSet);
    private static readonly Parser<TextSpan> PatternNonDigitsSetContains = Literals.Pattern(static c => NonDigitsSet.Contains(c));

    private static readonly Parser<TextSpan> NoneOfDigits = Literals.NoneOf(DigitsSet);
    private static readonly Parser<TextSpan> PatternNotDigit = Literals.Pattern(static c => !char.IsDigit(c));
    private static readonly Parser<TextSpan> PatternNotDigitContains = Literals.Pattern(static c => !DigitsSet.Contains(c));

    [GlobalSetup]
    public void Setup()
    {
        if (AnyOf_Digits().Length != DigitsInput.Length) throw new InvalidOperationException(nameof(AnyOf_Digits));
        if (Pattern_Digits().Length != DigitsInput.Length) throw new InvalidOperationException(nameof(Pattern_Digits));
        if (Pattern_Digits_Contains().Length != DigitsInput.Length) throw new InvalidOperationException(nameof(Pattern_Digits_Contains));

        if (AnyOf_NonDigitsSet().Length != LettersInput.Length) throw new InvalidOperationException(nameof(AnyOf_NonDigitsSet));
        if (Pattern_NonDigitsSet_Contains().Length != LettersInput.Length) throw new InvalidOperationException(nameof(Pattern_NonDigitsSet_Contains));

        if (NoneOf_NonDigits().Length != LettersInput.Length) throw new InvalidOperationException(nameof(NoneOf_NonDigits));
        if (Pattern_NonDigits().Length != LettersInput.Length) throw new InvalidOperationException(nameof(Pattern_NonDigits));
        if (Pattern_NonDigits_Contains().Length != LettersInput.Length) throw new InvalidOperationException(nameof(Pattern_NonDigits_Contains));
    }

    [Benchmark(Baseline = true), BenchmarkCategory("Digits: AnyOf vs Pattern")]
    public TextSpan AnyOf_Digits() => AnyOfDigits.Parse(DigitsInput);

    [Benchmark, BenchmarkCategory("Digits: AnyOf vs Pattern")]
    public TextSpan Pattern_Digits() => PatternIsDigit.Parse(DigitsInput);

    [Benchmark, BenchmarkCategory("Digits: AnyOf vs Pattern")]
    public TextSpan Pattern_Digits_Contains() => PatternDigitsContains.Parse(DigitsInput);

    [Benchmark(Baseline = true), BenchmarkCategory("NonDigitsSet: AnyOf vs Pattern")]
    public TextSpan AnyOf_NonDigitsSet() => AnyOfNonDigitsSet.Parse(LettersInput);

    [Benchmark, BenchmarkCategory("NonDigitsSet: AnyOf vs Pattern")]
    public TextSpan Pattern_NonDigitsSet_Contains() => PatternNonDigitsSetContains.Parse(LettersInput);

    [Benchmark(Baseline = true), BenchmarkCategory("NonDigits: NoneOf vs Pattern")]
    public TextSpan NoneOf_NonDigits() => NoneOfDigits.Parse(LettersInput);

    [Benchmark, BenchmarkCategory("NonDigits: NoneOf vs Pattern")]
    public TextSpan Pattern_NonDigits() => PatternNotDigit.Parse(LettersInput);

    [Benchmark, BenchmarkCategory("NonDigits: NoneOf vs Pattern")]
    public TextSpan Pattern_NonDigits_Contains() => PatternNotDigitContains.Parse(LettersInput);

}


/*

CONCLUSION: AnyOf/NoneOf is faster than Pattern, with contiguous or non-contiguous sets.

BenchmarkDotNet v0.15.8, macOS Sequoia 15.7.3 (24G419) [Darwin 24.6.0]
Apple M4 Pro, 1 CPU, 14 logical and 14 physical cores
.NET SDK 10.0.100
  [Host]   : .NET 10.0.0 (10.0.0, 10.0.25.52411), Arm64 RyuJIT armv8.0-a
  ShortRun : .NET 10.0.0 (10.0.0, 10.0.25.52411), Arm64 RyuJIT armv8.0-a

Job=ShortRun  IterationCount=3  LaunchCount=1
WarmupCount=3

| Method                        | Size | Mean     | Error    | StdDev   | Ratio | Gen0   | Allocated | Alloc Ratio |
|------------------------------ |----- |---------:|---------:|---------:|------:|-------:|----------:|------------:|
| AnyOf_Digits                  | 0    | 18.05 ns | 1.340 ns | 0.073 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_Digits                | 0    | 21.35 ns | 1.299 ns | 0.071 ns |  1.18 | 0.0287 |     240 B |        1.00 |
| Pattern_Digits_Contains       | 0    | 21.10 ns | 3.389 ns | 0.186 ns |  1.17 | 0.0287 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| AnyOf_Digits                  | 1    | 24.96 ns | 0.463 ns | 0.025 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_Digits                | 1    | 39.44 ns | 0.609 ns | 0.033 ns |  1.58 | 0.0287 |     240 B |        1.00 |
| Pattern_Digits_Contains       | 1    | 36.69 ns | 0.510 ns | 0.028 ns |  1.47 | 0.0287 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| AnyOf_Digits                  | 2    | 39.51 ns | 0.946 ns | 0.052 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_Digits                | 2    | 83.82 ns | 0.864 ns | 0.047 ns |  2.12 | 0.0286 |     240 B |        1.00 |
| Pattern_Digits_Contains       | 2    | 75.88 ns | 1.194 ns | 0.065 ns |  1.92 | 0.0286 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| NoneOf_NonDigits              | 0    | 18.19 ns | 0.280 ns | 0.015 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigits             | 0    | 20.64 ns | 2.017 ns | 0.111 ns |  1.13 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigits_Contains    | 0    | 22.03 ns | 0.419 ns | 0.023 ns |  1.21 | 0.0287 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| NoneOf_NonDigits              | 1    | 25.03 ns | 1.219 ns | 0.067 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigits             | 1    | 34.61 ns | 1.571 ns | 0.086 ns |  1.38 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigits_Contains    | 1    | 36.86 ns | 1.482 ns | 0.081 ns |  1.47 | 0.0287 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| NoneOf_NonDigits              | 2    | 44.18 ns | 0.513 ns | 0.028 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigits             | 2    | 79.04 ns | 1.047 ns | 0.057 ns |  1.79 | 0.0286 |     240 B |        1.00 |
| Pattern_NonDigits_Contains    | 2    | 88.50 ns | 1.570 ns | 0.086 ns |  2.00 | 0.0286 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| AnyOf_NonDigitsSet            | 0    | 21.97 ns | 0.775 ns | 0.042 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigitsSet_Contains | 0    | 21.40 ns | 0.591 ns | 0.032 ns |  0.97 | 0.0287 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| AnyOf_NonDigitsSet            | 1    | 29.08 ns | 0.313 ns | 0.017 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigitsSet_Contains | 1    | 36.87 ns | 0.859 ns | 0.047 ns |  1.27 | 0.0287 |     240 B |        1.00 |
|                               |      |          |          |          |       |        |           |             |
| AnyOf_NonDigitsSet            | 2    | 49.34 ns | 0.425 ns | 0.023 ns |  1.00 | 0.0287 |     240 B |        1.00 |
| Pattern_NonDigitsSet_Contains | 2    | 88.78 ns | 0.838 ns | 0.046 ns |  1.80 | 0.0286 |     240 B |        1.00 |
*/